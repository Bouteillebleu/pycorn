OBJECTS := main.o getpath.o frozen.o targetpy/libpython2.5.a
LIBS := -lm

HOSTPGEN := $(CURDIR)/hostpy/Parser/pgen

$(phony all): pykern.flash

frozen.o: CFLAGS += -IPython-2.5.2/Include -Itargetpy
	:scanner none

frozen.c: frozen/**/*.py freeze.py targetpy/pyconfig.h
	cd frozen; python ../freeze.py $(relative_to $(wildcard frozen/**/*.py),frozen)
	&mv frozen/frozen.c $(output)

targetpy/libpython2.5.a: $(HOSTPGEN) targetpy/Makefile
	cd targetpy; make HOSTPGEN=$(HOSTPGEN) EXTRA_CFLAGS="$(PYCFLAGS)" libpython2.5.a

targetpy/Makefile targetpy/pyconfig.h: Python-2.5.2/configure targetpy
	cd targetpy; MACHDEP=pycorn ../Python-2.5.2/configure --host=arm-eabi --without-signal-module

targetpy: Python-2.5.2
	rm -rf $(output)
	&mkdir $(output)

$(HOSTPGEN): hostpy/Makefile
	cd hostpy; make Parser/pgen

hostpy/Makefile: Python-2.5.2/configure hostpy
	cd hostpy; ../Python-2.5.2/configure

hostpy: Python-2.5.2
	rm -rf $(output) 
	&mkdir $(output)

Python-2.5.2/configure: Python-2.5.2 Python-2.5.2/configure.in
	cd Python-2.5.2; autoconf

Python-2.5.2: $(ROOT)/downloads/Python-2.5.2.tar.bz2 patches/*
	rm -rf $(output)
	tar jxf $(input)
	cd $(output); for p in `cat ../patches/series`; do patch -p1 < ../patches/$$p; done

no_implicit_load Python-2.5.2 hostpy targetpy

include common.mk
